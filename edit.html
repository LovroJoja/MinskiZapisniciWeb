<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Details</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>
<header>
	
	<div class="header-title"><a id="homeButton" href="index.html"><img src="home.png" alt="Home"></a><h1>Uređivanje zapisnika</h1></div>
</header>
	<form id="createForm" class="container" action="/update" method="POST" enctype="multipart/form-data">
		<div class="form-container">
			<div class="form-row">
				<label for="ID">ID:</label>
				<input type="number" id="ID" name="ID" required>
			</div>

			<div class="form-row">
				<label for="GKZona">GKZona:</label>
				<select id="GKZona" name="GKZona"></select>

				<label for="GKN">GKN:</label>
				<input type="number" id="GKN" name="GKN">

				<label for="GKE">GKE:</label>
				<input type="number" id="GKE" name="GKE">
			</div>

			<div class="form-row">
				<label for="UNSektor">UNSektor:</label>
				<select id="UNSektor" name="UNSektor"></select>

				<label for="OznakaUN">OznakaUN:</label>
				<select id="OznakaUN" name="OznakaUN"></select>

				<label for="Oznaka">Oznaka:</label>
				<input type="number" id="Oznaka" name="Oznaka">
			</div>

			<div class="form-row">
				<label for="Zupanija">Županija:</label>
				<select id="Zupanija" name="Zupanija"></select>

				<label for="Opcina">Općina:</label>
				<select id="Opcina" name="Opcina"></select>

				<label for="Naselje">Naselje:</label>
				<select id="Naselje" name="Naselje"></select>
			</div>

			<div class="form-row">
				<label for="VojskaID">VojskaID:</label>
				<select id="VojskaID" name="VojskaID"></select>

				<label for="Datum">Datum:</label>
				<input type="date" id="Datum" name="Datum" required>
			</div>

			<div class="form-row">
				<label for="POM">POM:</label>
				<input type="number" id="POM" name="POM" value="0" required>
				<label for="PPM">PPM:</label>
				<input type="number" id="PPM" name="PPM" value="0" required>
				<label for="Ostala">Ostala:</label>
				<input type="number" id="Ostala" name="Ostala" value="0" required>
			</div>

			<div class="form-row">
				<label for="Provjere">Provjere:</label><br>
				<input type="radio" id="Prvojere1" name="Provjere" value="1">
				<label for="Provjere1">1</label>
				<input type="radio" id="Prvojere0" name="Provjere" value="0">
				<label for="Provjere0">0</label><br>

				<label for="TipPolja">Tip polja:</label><br>
				<input type="radio" id="TipPoljaPOM" name="TipPolja" value="POM">
				<label for="TipPoljaPOM">POM</label><br>
				<input type="radio" id="TipPoljaPPM" name="TipPolja" value="PPM">
				<label for="TipPoljaPPM">PPM</label><br>
				<input type="radio" id="TipPoljaOstala" name="TipPolja" value="Ostala">
				<label for="TipPoljaOstala">Ostala</label><br>
			</div>
			<div class="form-row">
				<label for="image">Image:</label>
				<input type="file" name="image" id="image">
			</div>
			<div class="form-row">
				<input type="submit" value="Submit">
			</div>
		</div>
	</form>
	<div id="dropArea">
		<p>Drag & Drop Image Here (Preview below)</p>
	</div>
	<div id="imagePreview"></div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script type="text/javascript">

		fetch('http://localhost:3000/')
		.then(response => response.json())
		.then(data => {
			const gKZonaList = new Set();
			const uNSektorList = new Set();
			const oznakaUNList = new Set();
			const županijaList = new Set();
			const općinaList = new Set();
			const naseljeList = new Set();
			const vojskaIDList = new Set();

			data.forEach(row => {
				if (!gKZonaList.has(row.GKZona)){
					gKZonaList.add(row.GKZona);
				}
				if (!uNSektorList.has(row.UNSektor)){
					uNSektorList.add(row.UNSektor);
				}
				if (!oznakaUNList.has(row.OznakaUN)){
					oznakaUNList.add(row.OznakaUN);
				}
				if (!županijaList.has(row.Županija)){
					županijaList.add(row.Županija);
				}
				if (!općinaList.has(row.Općina)){
					općinaList.add(row.Općina);
				}
				if (!naseljeList.has(row.Naselje)){
					naseljeList.add(row.Naselje);
				}

				if (!vojskaIDList.has(row.VojskaID)){
					vojskaIDList.add(row.VojskaID);
				}

			});

			populateDropdown('GKZona', gKZonaList);
			populateDropdown('UNSektor', uNSektorList);
			populateDropdown('OznakaUN', oznakaUNList);			
			populateDropdown('Zupanija', županijaList);
			populateDropdown('Opcina', općinaList);
			populateDropdown('Naselje', naseljeList);
			populateDropdown('VojskaID', vojskaIDList);

			//console.log(županijaList)
		}).catch(error => console.error('Error fetching data:', error));

		function populateDropdown(dropdownID, optionsSet){
			const dropdown = document.getElementById(dropdownID);
			optionsSet.forEach(option => {
				if (option !== ''){
					const optionElement = document.createElement('option');
					optionElement.textContent = option;
					dropdown.appendChild(optionElement);
				}
			});
		}






		const urlParams = new URLSearchParams(window.location.search);
		const id = urlParams.get('id');
		console.log(id);
		document.getElementById('ID').value = id;
		document.getElementById('ID').disabled = true;
		fetch(`http://localhost:3000/details?id=${id}`)
		.then(response => response.json())
		.then(data => {

			entries = Object.entries(data);
			console.log(entries[1][1]);
			document.getElementById('GKZona').value = entries[1][1];
			document.getElementById('GKN').value = entries[2][1];
			document.getElementById('GKE').value = entries[3][1];
			document.getElementById('UNSektor').value = entries[4][1];
			document.getElementById('OznakaUN').value = entries[5][1];
			document.getElementById('Oznaka').value = entries[6][1];
			document.getElementById('Zupanija').value = entries[7][1];
			document.getElementById('Opcina').value = entries[8][1];
			document.getElementById('Naselje').value = entries[9][1];
			document.getElementById('VojskaID').value = entries[10][1];
			//const dateParts = Datum.split("-");
			const dateParts = entries[11][1].split("/");
			const year = parseInt(dateParts[2]);
			const month = parseInt(dateParts[0]);
			const day = parseInt(dateParts[1]);
			console.log(dateParts);
			const yDate = new Date(year, month - 1, day + 1);
			const formattedDate = yDate.toISOString().split('T')[0];
    		//const formattedDate = `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;
			document.getElementById('Datum').value = formattedDate;
			document.getElementById('POM').value = entries[12][1];
			document.getElementById('PPM').value = entries[13][1];
			document.getElementById('Ostala').value = entries[14][1];
			const selectedProvjere = entries[15][1];
			document.querySelector(`input[name="Provjere"][value="${selectedProvjere}"]`).checked = true;
			const selectedTipPolja = entries[16][1];
			document.querySelector(`input[name="TipPolja"][value="${selectedTipPolja}"]`).checked = true;
			for (let i = 1; i < entries.length; i++){
				const [key, value] = entries[i];
				console.log(key + ": " + value);
			}
		});

		$(document).ready(function() {
			$('#createForm').submit(function(e) {
				e.preventDefault();
				var formData = new FormData(this);
				var imageFile = document.getElementById('image').files

				//var id = $('ID').val();
				console.log(id)
				formData.append('ID', id);
				if ('imageFile'){
					formData.append('image', imageFile)
				} else{
					console.log("No image");
				}
				//console.log(formData);
				$.ajax({
					url: 'http://localhost:3000/update',
					type: 'POST',
					data: formData,
					processData: false,
					contentType: false,
					success: function(response){
						console.log(response);
						if (response.message){
							alert(response.message)
						}
					},
					error: function(xhr, status, error){
						console.error(error);

						if (xhr.status === 400) {
							alert(xhr.responseJSON.message);
						}
					}
				});
			});
		});
		var dropArea = document.getElementById('dropArea');

			['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
				dropArea.addEventListener(eventName, preventDefaults, false)
			});

			function preventDefaults (e) {
				e.preventDefault()
				e.stopPropagation()
			}
			;['dragenter', 'dragover'].forEach(eventName => {
				dropArea.addEventListener(eventName, highlight, false)
			});

			;['dragleave', 'drop'].forEach(eventName => {
				dropArea.addEventListener(eventName, unhighlight, false)
			});

			function highlight(e){
				dropArea.classList.add('highlight')
			}
			function unhighlight(e){
				dropArea.classList.remove('highlight');
			}

			dropArea.addEventListener('drop', handleDrop, false);

			function handleDrop(e){
				let dt = e.dataTransfer
				let files = dt.files

				handleFiles(files)
				document.getElementById('image').files = files;
			}

			function handleFiles(files){
				files = [...files]
				files.forEach(uploadFile)
			}

			function uploadFile(file){
				let reader = new FileReader();

				reader.onload = function(event){

					let img = document.createElement('img');
					img.src = event.target.result;
					document.getElementById('imagePreview').innerHTML = ''
					document.getElementById('imagePreview').appendChild(img);

				}
				reader.readAsDataURL(file);
			}
	</script>
</body>
</html>